---
title: "DockQ Benchmark Report"
date: "`r format(Sys.time(), '%d %B, %Y %H:%M:%S')`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    code_download: true
    number_sections: true
    df_print: kable
    theme: lumen
params:
  output_dir: "output"
  dockq_files: NULL
  mean_dockq_files: NULL
  correlation_files: NULL
editor_options:
  chunk_output_type: console
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(readr)
library(patchwork)

output_dir <- params$output_dir
dockq_files <- params$dockq_files
mean_dockq_files <- params$mean_dockq_files
correlation_files <- params$correlation_files

# Extract dataset names from file basenames
get_dataset <- function(x) sub("\\..*$", "", basename(x))
datasets <- unique(c(
  sapply(dockq_files, get_dataset),
  sapply(mean_dockq_files, get_dataset),
  sapply(correlation_files, get_dataset)
))
```

# DockQ Scatter Plots

```{r dockq-scatter-combined, fig.width=18, fig.height=5, warning=FALSE, message=FALSE, results='hide', echo=FALSE}
plots <- list()
for (f in dockq_files) {
  ds <- sub("\\..*$", "", basename(f))
  df <- read_csv(f)
  if ("dockq" %in% names(df)) {
    x_col <- if (ds %in% names(df)) ds else names(df)[1]
    # Color rank1 differently
    df$rank_type <- ifelse(df$rank == 1, "rank1", "other")
    p <- ggplot(df, aes_string(x = x_col, y = "dockq", color = "rank_type")) +
      geom_point(alpha = 0.7) +
      scale_color_manual(values = c("rank1" = "#E41A1C", "other" = "#377EB8")) +
      labs(title = paste(ds, "DockQ Scatter Plot"), x = ds, y = "DockQ", color = "Rank") +
      theme_classic() +
      ylim(0, 1) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1))
    plots[[ds]] <- p
  } else {
    message(paste("File", f, "does not contain a 'dockq' column. Skipping."))
  }
}
wrap_plots(plots)
```

# Mean DockQ Bar Plots

```{r meandockq-bar-combined, fig.width=18, fig.height=5, warning=FALSE, message=FALSE, results='hide', echo=FALSE}
plots <- list()
for (f in mean_dockq_files) {
  ds <- sub("\\..*$", "", basename(f))
  df <- read_csv(f)
  df_filtered <- df %>% filter(metric %in% c("all", "rank1", "best_dockq"))
  p <- ggplot(df_filtered, aes(x = metric, y = value, fill = metric)) +
    geom_bar(stat = "identity", position = "dodge") +
    labs(title = paste(ds, "Mean DockQ"), x = "Type", y = "Mean DockQ") +
    theme_classic() +
    ylim(0, 1)
  plots[[ds]] <- p
}
wrap_plots(plots)
```

# Correlation Plots

```{r correlation-plots-combined, fig.width=18, fig.height=10, warning=FALSE, message=FALSE, results='hide', echo=FALSE, eval=FALSE}
pearson_plots <- list()
spearman_plots <- list()
for (f in correlation_files) {
  ds <- sub("\\..*$", "", basename(f))
  df <- read_csv(f)
  # Filter only 'all' and 'rank1' methods
  df <- df %>% filter(method %in% c("all"))
  # Pearson plot for selected methods
  df_pearson <- df %>% filter(metric == "pearson" & !is.na(r))
  if (nrow(df_pearson) > 0) {
    p <- ggplot(df_pearson, aes(x = feature, y = r, fill = method)) +
      geom_bar(stat = "identity", position = "dodge") +
      coord_flip() +
      facet_wrap(~method, ncol = 1) +
      labs(title = paste(ds, "Pearson Correlation by Method"), x = "Feature", y = "Pearson r") +
      theme_classic() +
      ylim(-1, 1)
    pearson_plots[[ds]] <- p
  }
  # Spearman plot for selected methods
  df_spearman <- df %>% filter(metric == "spearman" & !is.na(r))
  if (nrow(df_spearman) > 0) {
    p <- ggplot(df_spearman, aes(x = feature, y = r, fill = method)) +
      geom_bar(stat = "identity", position = "dodge") +
      coord_flip() +
      facet_wrap(~method, ncol = 1) +
      labs(title = paste(ds, "Spearman Correlation by Method"), x = "Feature", y = "Spearman r") +
      theme_classic() +
      ylim(-1, 1)
    spearman_plots[[ds]] <- p
  }
}
wrap_plots(pearson_plots) / wrap_plots(spearman_plots)
```

# Correlation Plots

```{r correlation-plots-combined, fig.width=18, fig.height=10, warning=FALSE, message=FALSE, results='hide', echo=FALSE}
pearson_plots <- list()
spearman_plots <- list()
for (f in correlation_files) {
  ds <- sub("\\..*$", "", basename(f))
  df <- read_csv(f)
  # Filter only 'all' method
  df <- df %>% filter(method == "all")
  # Pearson plot for 'all' method
  df_pearson <- df %>% filter(metric == "pearson" & !is.na(r))
  if (nrow(df_pearson) > 0) {
    p <- ggplot(df_pearson, aes(x = feature, y = r, fill = feature)) +
      geom_bar(stat = "identity", position = "dodge") +
      coord_flip() +
      labs(title = paste(ds, "Pearson Correlation (all method)"), x = "Feature", y = "Pearson r") +
      theme_classic() +
      ylim(-1, 1)
    pearson_plots[[ds]] <- p
  }
  # Spearman plot for 'all' method
  df_spearman <- df %>% filter(metric == "spearman" & !is.na(r))
  if (nrow(df_spearman) > 0) {
    p <- ggplot(df_spearman, aes(x = feature, y = r, fill = feature)) +
      geom_bar(stat = "identity", position = "dodge") +
      coord_flip() +
      labs(title = paste(ds, "Spearman Correlation (all method)"), x = "Feature", y = "Spearman r") +
      theme_classic() +
      ylim(-1, 1)
    spearman_plots[[ds]] <- p
  }
}
wrap_plots(pearson_plots) / wrap_plots(spearman_plots)
```